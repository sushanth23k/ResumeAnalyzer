# ============================================================
# Resume Analyzer — Backend Docker Compose
# Services: Django/Gunicorn only
#
# Database connection is configured via environment variables in Django settings.
# Set DB_URL or DB_POOL_URL in your .env file to point to your external database.
#
# Usage:
#   cp .env.example .env        # fill in secrets and DB_URL
#   docker compose up --build
#
# The backend API is available at http://localhost:8000
# ============================================================

services:

  # ── Django + Gunicorn ─────────────────────────────────────────────────────
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: resumeanalyzer_backend
    restart: unless-stopped
    command: >
      sh -c "
        python manage.py migrate --noinput &&
        python manage.py collectstatic --noinput &&
        gunicorn --config gunicorn.conf.py ResumeAnalyzer.wsgi:application
      "
    volumes:
      - media_volume:/app/ResumeBlobs
      - static_volume:/app/staticfiles
    environment:
      - DEBUG=${DEBUG:-False}
      - SECRET_KEY=${SECRET_KEY:-change-this-in-production}
      - DB_URL=${DB_URL}
      - DB_POOL_URL=${DB_POOL_URL:-}
      - DB_SSL_REQUIRE=${DB_SSL_REQUIRE:-True}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1,backend}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - MODEL_NAME=${MODEL_NAME:-llama3-8b-8192}
      - EMAIL_BACKEND=${EMAIL_BACKEND:-django.core.mail.backends.console.EmailBackend}
      - REQUIRE_EMAIL_VERIFICATION=${REQUIRE_EMAIL_VERIFICATION:-False}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
    ports:
      - "8000:8000"
    networks:
      - backend_network

networks:
  backend_network:
    driver: bridge
    name: resumeanalyzer_backend_network

volumes:
  media_volume:
    name: resumeanalyzer_media
  static_volume:
    name: resumeanalyzer_static
